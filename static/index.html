<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‡ªå‹•è²©å£²æ©Ÿã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .product-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy {
            background-color: #28a745;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .status-error {
            background-color: #dc3545;
        }
        .chat-message {
            max-width: 70%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 15px;
        }
        .chat-user {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }
        .chat-bot {
            background-color: #f8f9fa;
            color: #333;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>
                AIè‡ªå‹•è²©å£²æ©Ÿã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
            </a>
            <div class="d-flex align-items-center">
                <span class="status-indicator status-healthy" id="systemStatus"></span>
                <span class="text-light me-3">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æ­£å¸¸</span>
                <button class="btn btn-outline-light btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> æ›´æ–°
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>ãƒã‚·ãƒ³ID:</strong> <span id="machineId">AI_VM001</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> <span id="version">1.0.0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span id="status">é‹ç”¨ä¸­</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰:</strong> <span id="debugMode">æœ‰åŠ¹</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="scenarios-tab" data-bs-toggle="tab" data-bs-target="#scenarios" type="button" role="tab">
                    <i class="fas fa-play-circle"></i> ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                    <i class="fas fa-box"></i> å•†å“ç®¡ç†
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                    <i class="fas fa-comments"></i> é¡§å®¢å¯¾å¿œ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i> åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="fas fa-cog"></i> è¨­å®š
                </button>
            </li>
        </ul>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="tab-content" id="mainTabsContent">
            <!-- ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆã‚¿ãƒ– -->
            <div class="tab-pane fade show active" id="scenarios" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-8">
                        <h4><i class="fas fa-play-circle"></i> ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ</h4>
                        <p class="text-muted">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚</p>

                        <!-- ã‚·ãƒŠãƒªã‚ªé¸æŠ -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5><i class="fas fa-list"></i> ã‚·ãƒŠãƒªã‚ªé¸æŠ</h5>
                            </div>
                            <div class="card-body">
                                <div class="row" id="scenarioList">
                                    <!-- ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-success" onclick="runAllScenarios()">
                                        <i class="fas fa-play"></i> å…¨ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- å®Ÿè¡Œçµæœ -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> å®Ÿè¡Œçµæœ</h5>
                            </div>
                            <div class="card-body">
                                <div id="scenarioResults" style="max-height: 400px; overflow-y: auto;">
                                    <!-- ã‚·ãƒŠãƒªã‚ªå®Ÿè¡ŒçµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <p>ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- ã‚·ãƒŠãƒªã‚ªæƒ…å ± -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle"></i> ã‚·ãƒŠãƒªã‚ªæƒ…å ±</h5>
                            </div>
                            <div class="card-body">
                                <div id="scenarioInfo">
                                    <p>ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã™ã‚‹ã¨è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                                </div>
                            </div>
                        </div>

                        <!-- å®Ÿè¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5><i class="fas fa-cog"></i> å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                    <label class="form-check-label" for="autoRefresh">
                                        è‡ªå‹•æ›´æ–°
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showDetails" checked>
                                    <label class="form-check-label" for="showDetails">
                                        è©³ç´°ãƒ­ã‚°è¡¨ç¤º
                                    </label>
                                </div>
                                <button class="btn btn-secondary w-100 mt-3" onclick="clearResults()">
                                    <i class="fas fa-trash"></i> çµæœã‚¯ãƒªã‚¢
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å•†å“ç®¡ç†ã‚¿ãƒ– -->
            <div class="tab-pane fade show active" id="products" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-8">
                        <h4>å•†å“ä¸€è¦§</h4>
                        <div id="productsList" class="row">
                            <!-- å•†å“ã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-shopping-cart"></i> è³¼å…¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">å•†å“ID</label>
                                    <input type="text" class="form-control" id="productId" placeholder="ä¾‹: drink_cola">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ•°é‡</label>
                                    <input type="number" class="form-control" id="quantity" value="1" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ±ºæ¸ˆæ–¹æ³•</label>
                                    <select class="form-control" id="paymentMethod">
                                        <option value="cash">ç¾é‡‘</option>
                                        <option value="card">ã‚«ãƒ¼ãƒ‰</option>
                                        <option value="coupon">ã‚¯ãƒ¼ãƒãƒ³</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary w-100" onclick="simulatePurchase()">
                                    <i class="fas fa-credit-card"></i> è³¼å…¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                                </button>
                                <div id="purchaseResult" class="mt-3" style="display: none;">
                                    <!-- è³¼å…¥çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¡§å®¢å¯¾å¿œã‚¿ãƒ– -->
            <div class="tab-pane fade" id="chat" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-comments"></i> AIé¡§å®¢å¯¾å¿œ</h5>
                            </div>
                            <div class="card-body">
                                <div id="chatMessages" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                                    <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </div>
                                <div class="mt-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
                                        <button class="btn btn-primary" onclick="sendMessage()">
                                            <i class="fas fa-paper-plane"></i> é€ä¿¡
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle"></i> å¯¾å¿œæƒ…å ±</h5>
                            </div>
                            <div class="card-body">
                                <div id="chatInfo">
                                    <p>AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨ã®ãƒãƒ£ãƒƒãƒˆãŒå¯èƒ½ã§ã™ã€‚</p>
                                    <p>å•†å“ã®ãŠã™ã™ã‚ã€è³¼å…¥ç›¸è«‡ãªã©ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> è²©å£²åˆ†æ</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="salesChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-boxes"></i> åœ¨åº«çŠ¶æ³</h5>
                            </div>
                            <div class="card-body">
                                <div id="inventoryStatus">
                                    <!-- åœ¨åº«æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨­å®šã‚¿ãƒ– -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-cog"></i> ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="debugModeToggle" checked>
                                        <label class="form-check-label" for="debugModeToggle">æœ‰åŠ¹</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">AIå®‰å…¨æ€§é–¾å€¤</label>
                                    <input type="range" class="form-range" id="safetyThreshold" min="0.8" max="1.0" step="0.01" value="0.95">
                                    <div class="d-flex justify-content-between">
                                        <small>0.8</small>
                                        <small id="thresholdValue">0.95</small>
                                        <small>1.0</small>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="updateSettings()">
                                    <i class="fas fa-save"></i> è¨­å®šã‚’æ›´æ–°
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-shield-alt"></i> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h5>
                            </div>
                            <div class="card-body">
                                <div id="securityStatus">
                                    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è³¼å…¥çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è³¼å…¥çµæœ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="purchaseModalBody">
                    <!-- è³¼å…¥çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // APIåŸºåº•URL
        const API_BASE = 'http://localhost:8000';

        // ã‚·ãƒŠãƒªã‚ªé–¢é€£ã®å¤‰æ•°
        let currentScenarioResults = [];
        let autoRefreshInterval = null;

        // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—
        async function loadSystemInfo() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                document.getElementById('machineId').textContent = data.machine_id || 'AI_VM001';
                document.getElementById('version').textContent = '1.0.0';
                document.getElementById('status').textContent = data.status === 'healthy' ? 'æ­£å¸¸' : 'ç•°å¸¸';
                document.getElementById('debugMode').textContent = 'æœ‰åŠ¹';

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
                const statusIndicator = document.getElementById('systemStatus');
                statusIndicator.className = `status-indicator status-${data.status === 'healthy' ? 'healthy' : 'error'}`;

            } catch (error) {
                console.error('ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        // å•†å“ä¸€è¦§ã‚’å–å¾—
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/vending/products`);
                const products = await response.json();

                const productsList = document.getElementById('productsList');
                productsList.innerHTML = '';

                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsList.appendChild(productCard);
                });

            } catch (error) {
                console.error('å•†å“ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                document.getElementById('productsList').innerHTML =
                    '<div class="col-12"><div class="alert alert-danger">å•†å“æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div></div>';
            }
        }

        // å•†å“ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createProductCard(product) {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-3';

            col.innerHTML = `
                <div class="card product-card" onclick="selectProduct('${product.product_id}')">
                    <div class="card-body text-center">
                        <h6 class="card-title">${product.name}</h6>
                        <p class="card-text text-muted">${product.description || ''}</p>
                        <div class="fw-bold text-primary">Â¥${product.price}</div>
                        <div class="mt-2">
                            <span class="badge bg-${product.stock_quantity > 0 ? 'success' : 'danger'}">
                                åœ¨åº«: ${product.stock_quantity || 0}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        // å•†å“ã‚’é¸æŠ
        function selectProduct(productId) {
            document.getElementById('productId').value = productId;
        }

        // è³¼å…¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        async function simulatePurchase() {
            const productId = document.getElementById('productId').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!productId) {
                alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/vending/payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: 150 * quantity, // ä»®ã®é‡‘é¡
                        payment_method: paymentMethod,
                        product_ids: [productId]
                    })
                });

                const result = await response.json();

                // çµæœã‚’è¡¨ç¤º
                const modalBody = document.getElementById('purchaseModalBody');
                modalBody.innerHTML = `
                    <div class="text-center">
                        <h5>è³¼å…¥çµæœ</h5>
                        <div class="mt-3">
                            <div class="alert alert-${result.success ? 'success' : 'danger'}">
                                ${result.success ? 'âœ… è³¼å…¥æˆåŠŸ' : 'âŒ è³¼å…¥å¤±æ•—'}
                            </div>
                            ${result.payment_id ? `<p>æ±ºæ¸ˆID: ${result.payment_id}</p>` : ''}
                            ${result.error_message ? `<p>ã‚¨ãƒ©ãƒ¼: ${result.error_message}</p>` : ''}
                        </div>
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('purchaseModal')).show();

            } catch (error) {
                console.error('è³¼å…¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('è³¼å…¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendMessage() {
            const message = document.getElementById('chatInput').value.trim();
            if (!message) return;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addChatMessage('user', message);
            document.getElementById('chatInput').value = '';

            try {
                // ãƒãƒ£ãƒƒãƒˆé–‹å§‹
                const startResponse = await fetch(`${API_BASE}/api/v1/tablet/chat/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: 'user_001',
                        initial_message: message
                    })
                });

                const startResult = await startResponse.json();

                // AIå¿œç­”ã‚’è¡¨ç¤º
                addChatMessage('bot', startResult.message || 'AIå¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸ');

            } catch (error) {
                console.error('ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                addChatMessage('bot', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${sender}`;
            messageDiv.textContent = message;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        function refreshData() {
            loadSystemInfo();
            loadProducts();
        }

        // è¨­å®šæ›´æ–°
        function updateSettings() {
            alert('è¨­å®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
        }

        // ã‚·ãƒŠãƒªã‚ªé–¢é€£é–¢æ•°
        async function loadScenarios() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/scenarios`);
                const data = await response.json();

                const scenarioList = document.getElementById('scenarioList');
                scenarioList.innerHTML = '';

                for (const [key, scenario] of Object.entries(data.scenarios)) {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 mb-2';

                    col.innerHTML = `
                        <div class="card scenario-card" onclick="selectScenario('${key}')">
                            <div class="card-body">
                                <h6 class="card-title">${scenario.name}</h6>
                                <p class="card-text small text-muted">${scenario.description}</p>
                                <button class="btn btn-primary btn-sm" onclick="runScenario('${key}'); event.stopPropagation();">
                                    <i class="fas fa-play"></i> å®Ÿè¡Œ
                                </button>
                            </div>
                        </div>
                    `;

                    scenarioList.appendChild(col);
                }

            } catch (error) {
                console.error('ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        function selectScenario(scenarioKey) {
            // ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠï¼ˆè¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('border-primary');
            });

            const selectedCard = document.querySelector(`[onclick="selectScenario('${scenarioKey}')"]`).closest('.scenario-card');
            if (selectedCard) {
                selectedCard.classList.add('border-primary');
            }

            // ã‚·ãƒŠãƒªã‚ªæƒ…å ±ã‚’è¡¨ç¤º
            showScenarioInfo(scenarioKey);
        }

        async function showScenarioInfo(scenarioKey) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/scenarios`);
                const data = await response.json();

                const scenario = data.scenarios[scenarioKey];
                if (scenario) {
                    document.getElementById('scenarioInfo').innerHTML = `
                        <h6>${scenario.name}</h6>
                        <p class="small">${scenario.description}</p>
                        <hr>
                        <small class="text-muted">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã€ã¾ãŸã¯å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</small>
                    `;
                }
            } catch (error) {
                console.error('ã‚·ãƒŠãƒªã‚ªæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        async function runScenario(scenarioKey) {
            try {
                // å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const button = document.querySelector(`[onclick="runScenario('${scenarioKey}')"]`);
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®Ÿè¡Œä¸­...';
                button.disabled = true;

                // ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ
                const response = await fetch(`${API_BASE}/api/v1/scenarios/${scenarioKey}/run`, {
                    method: 'POST'
                });

                const result = await response.json();

                // çµæœã‚’è¡¨ç¤º
                displayScenarioResult(result);

                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                button.innerHTML = originalText;
                button.disabled = false;

            } catch (error) {
                console.error('ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚·ãƒŠãƒªã‚ªã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');

                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                const button = document.querySelector(`[onclick="runScenario('${scenarioKey}')"]`);
                if (button) {
                    button.innerHTML = '<i class="fas fa-play"></i> å®Ÿè¡Œ';
                    button.disabled = false;
                }
            }
        }

        async function runAllScenarios() {
            try {
                // å…¨å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const button = document.querySelector('[onclick="runAllScenarios()"]');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®Ÿè¡Œä¸­...';
                button.disabled = true;

                // å…¨ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ
                const response = await fetch(`${API_BASE}/api/v1/scenarios/run-all`, {
                    method: 'POST'
                });

                const result = await response.json();

                // çµæœã‚’è¡¨ç¤º
                displayScenarioResult(result);

                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                button.innerHTML = originalText;
                button.disabled = false;

            } catch (error) {
                console.error('å…¨ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                alert('å…¨ã‚·ãƒŠãƒªã‚ªã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');

                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                const button = document.querySelector('[onclick="runAllScenarios()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-play"></i> å…¨ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ';
                    button.disabled = false;
                }
            }
        }

        function displayScenarioResult(result) {
            const resultsDiv = document.getElementById('scenarioResults');

            if (result.error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>ã‚¨ãƒ©ãƒ¼</h6>
                        <p>${result.error}</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="alert alert-${result.success ? 'success' : 'danger'}">
                    <h6>${result.scenario_name || 'ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œçµæœ'}</h6>
                    <p>${result.message}</p>
                    <small>å®Ÿè¡Œæ™‚é–“: ${result.duration_seconds?.toFixed(1)}ç§’</small>
                </div>
            `;

            // è©³ç´°ãƒ­ã‚°è¡¨ç¤ºãŒæœ‰åŠ¹ãªå ´åˆ
            if (document.getElementById('showDetails').checked && result.results) {
                html += '<div class="mt-3"><h6>å®Ÿè¡Œè©³ç´°:</h6>';
                result.results.forEach((step, index) => {
                    const icon = step.step.includes('æˆåŠŸ') ? 'âœ…' :
                               step.step.includes('å¤±æ•—') ? 'âŒ' :
                               step.step.includes('é–‹å§‹') ? 'ğŸš€' : 'ğŸ“';

                    html += `
                        <div class="border rounded p-2 mb-2">
                            <small><strong>${icon} ${step.step}</strong></small>
                            ${step.details ? `<br><small class="text-muted">${JSON.stringify(step.details, null, 2)}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            resultsDiv.innerHTML = html;

            // è‡ªå‹•æ›´æ–°ãŒæœ‰åŠ¹ãªå ´åˆ
            if (document.getElementById('autoRefresh').checked) {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                autoRefreshInterval = setInterval(() => {
                    // æœ€æ–°ã®çµæœã‚’å–å¾—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯çµæœå–å¾—APIãŒå¿…è¦ï¼‰
                }, 2000);
            }
        }

        function clearResults() {
            document.getElementById('scenarioResults').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
                </div>
            `;

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemInfo();
            loadProducts();
            loadScenarios(); // ã‚·ãƒŠãƒªã‚ªä¸€è¦§ã‚’èª­ã¿è¾¼ã¿

            // Enterã‚­ãƒ¼ã§ãƒãƒ£ãƒƒãƒˆé€ä¿¡
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
